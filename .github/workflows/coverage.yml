name: Coverage

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  coverage:
    runs-on: ubuntu-latest
    env:
      CARGO_TERM_COLOR: always
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust toolchain and target
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: wasm32-wasip1
          components: llvm-tools-preview

      - name: Install cargo-llvm-cov
        run: cargo install cargo-llvm-cov --locked

      - name: Run coverage (unit tests)
        run: make test-coverage

      - name: Upload coverage artifact
        uses: actions/upload-artifact@v4
        with:
          name: coverage-lcov
          path: lcov.info

      - name: Publish coverage summary
        run: |
          if [ ! -f lcov.info ]; then
            echo "lcov.info not found"
            exit 1
          fi
          LF=$(awk -F: '/^LF:/{sum+=$2} END {print sum+0}' lcov.info)
          LH=$(awk -F: '/^LH:/{sum+=$2} END {print sum+0}' lcov.info)
          if [ "${LF}" -gt 0 ]; then
            PCT=$(awk -v lh="${LH}" -v lf="${LF}" 'BEGIN { printf "%.2f", (lh/lf)*100 }')
          else
            PCT="0.00"
          fi
          {
            echo "## Coverage Summary"
            echo ""
            echo "| Metric | Value |"
            echo "|---|---:|"
            echo "| Lines Hit | ${LH} |"
            echo "| Lines Found | ${LF} |"
            echo "| Line Coverage | ${PCT}% |"
            echo ""
            echo "Coverage artifact: \`coverage-lcov\` (\`lcov.info\`)."
          } >> "$GITHUB_STEP_SUMMARY"
