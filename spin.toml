spin_manifest_version = 2
[application]
name = "shuma-gorath"
version = "0.1.0"
authors = ["Your Name <your@email.com>"]
description = "Shuma-Gorath: Many-Angled Bot Defence for Fermyon Spin."

# Dashboard static files (served first)
[[trigger.http]]
route = "/dashboard/..."
component = "dashboard-files"

# Main bot trap handler (catch-all)
[[trigger.http]]
route = "/..."
component = "bot-trap"

# Static file server for dashboard
[component.dashboard-files]
source = { url = "https://github.com/fermyon/spin-fileserver/releases/download/v0.3.0/spin_static_fs.wasm", digest = "sha256:ef88708817e107bf49985c7cefe4dd1f199bf26f6727819183d5c996baa3d148" }
files = [{ source = "dashboard", destination = "/" }]
environment = { CACHE_CONTROL = "no-store, max-age=0, must-revalidate" }

[component.bot-trap]
source = "src/bot_trap.wasm"
key_value_stores = ["default"]
# Tight outbound policy: this component should not initiate external HTTP(S) calls.
allowed_outbound_hosts = []
## NOTE: For production/CI, do NOT commit secrets here. Move `SHUMA_API_KEY`,
## `SHUMA_JS_SECRET`, and `SHUMA_KV_STORE_FAIL_OPEN` into your CI/deployment secret store and inject
## them at deploy/runtime. This inline placeholder is for local/dev only.
## `SHUMA_FORWARDED_IP_SECRET` should be set in every environment where X-Forwarded-For
## is trusted. Requests without a matching X-Shuma-Forwarded-Secret are ignored.
environment = { SHUMA_JS_SECRET = "changeme-js-secret", SHUMA_EVENT_LOG_RETENTION_HOURS = "168", SHUMA_ADMIN_IP_ALLOWLIST = "", SHUMA_KV_STORE_FAIL_OPEN = "true", SHUMA_POW_ENABLED = "true", SHUMA_POW_DIFFICULTY = "15", SHUMA_POW_TTL_SECONDS = "90", SHUMA_POW_CONFIG_MUTABLE = "false" }

[component.bot-trap.build]
command = "./scripts/set_crate_type.sh cdylib && cargo build --target wasm32-wasip1 --release && cp target/wasm32-wasip1/release/shuma_gorath.wasm src/bot_trap.wasm && ./scripts/set_crate_type.sh rlib"
