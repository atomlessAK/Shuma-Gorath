spin_manifest_version = 2
[application]
name = "shuma-gorath"
version = "0.1.0"
authors = ["Your Name <your@email.com>"]
description = "Shuma-Gorath: Chaos Dimension Bot Defence for Fermyon Spin."

# Dashboard static files (served first)
[[trigger.http]]
route = "/dashboard/..."
component = "dashboard-files"

# Main bot defence handler (catch-all)
[[trigger.http]]
route = "/..."
component = "bot-defence"

# Static file server for dashboard
[component.dashboard-files]
source = { url = "https://github.com/fermyon/spin-fileserver/releases/download/v0.3.0/spin_static_fs.wasm", digest = "sha256:ef88708817e107bf49985c7cefe4dd1f199bf26f6727819183d5c996baa3d148" }
files = [{ source = "dashboard", destination = "/" }]
environment = { CACHE_CONTROL = "no-store, max-age=0, must-revalidate" }

[component.bot-defence]
source = "dist/wasm/shuma_gorath.wasm"
key_value_stores = ["default"]
# Tight outbound policy: this component should not initiate external HTTP(S) calls.
allowed_outbound_hosts = []
## NOTE: For production/CI, inject env-only secrets/guardrails via your deployment secret store.
## Tunables are loaded from KV only (seeded from config/defaults.env by make setup/config-seed).
## `SHUMA_FORWARDED_IP_SECRET` should be set in every environment where X-Forwarded-For
## is trusted. Requests without a matching X-Shuma-Forwarded-Secret are ignored.

[component.bot-defence.build]
command = "./scripts/set_crate_type.sh cdylib && cargo build --target wasm32-wasip1 --release && mkdir -p dist/wasm && cp target/wasm32-wasip1/release/shuma_gorath.wasm dist/wasm/shuma_gorath.wasm && ./scripts/set_crate_type.sh rlib"
