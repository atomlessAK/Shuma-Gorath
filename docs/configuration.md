# üêô Configuration

Shuma-Gorath uses one runtime configuration model:

- Tunables are stored in KV under `config:<site_id>` (default `config:default`).
- Env vars are reserved for secrets and runtime guardrails.
- `config/defaults.env` is the canonical source for defaults (no hidden tunable defaults in Rust).

## üêô Startup Model

`make setup`:

1. Creates `.env.local` from `config/defaults.env` if missing.
2. Generates local dev secrets in `.env.local` (`SHUMA_API_KEY`, `SHUMA_JS_SECRET`, `SHUMA_FORWARDED_IP_SECRET`).
3. Runs `make config-seed`, which creates `config:default` when missing and backfills newly introduced tunable keys when the record already exists.
4. Normalizes `.env.local` entries to unquoted `KEY=value` style for consistency.

At runtime:

- Tunables are loaded from KV.
- Env-only keys are loaded from process env.
- Missing/invalid KV config returns `500 Configuration unavailable` for config-dependent requests.
- `make dev`, `make run`, `make run-prebuilt`, and `make prod` now run `make config-seed` before Spin startup (and `make dev`/`make dev-closed` also backfill on watch-triggered restarts), so newly added tunables are automatically backfilled after branch switches or `make clean`.

## üêô Runtime Config Cache

- KV-backed runtime config is cached in-process for a short TTL (currently 2 seconds).
- `POST /admin/config` invalidates the cache on the handling instance immediately after a successful KV write.
- In multi-instance deployments, other instances refresh on their own TTL window, so brief config staleness (up to TTL) is expected.

## üêô Canonical Variable Reference

Reference files:

- `config/defaults.env` (all defaults)
- `.env.local` (generated by `make setup`; env-only override source, gitignored)

### üêô Env-Only Runtime Keys

These are read from process env at runtime (not from KV).

| Variable | Required | Default in `config/defaults.env` | Purpose |
| --- | --- | --- | --- |
| `SHUMA_API_KEY` | Yes | `changeme-prod-api-key` | Admin authentication key for dashboard login and `Authorization: Bearer` admin API calls. |
| `SHUMA_ADMIN_READONLY_API_KEY` | No | empty | Optional read-only admin bearer key for non-mutating `/admin/*` endpoints; write actions still require `SHUMA_API_KEY` or an admin session created from it. |
| `SHUMA_JS_SECRET` | Yes | `changeme-prod-js-secret` | Signs and verifies `js_verified` cookie. |
| `SHUMA_POW_SECRET` | No | empty | Optional dedicated PoW signing secret. Falls back to `SHUMA_JS_SECRET` when unset. |
| `SHUMA_CHALLENGE_SECRET` | No | empty | Optional dedicated challenge signing secret. Falls back to `SHUMA_JS_SECRET` when unset. |
| `SHUMA_MAZE_PREVIEW_SECRET` | No | empty | Optional dedicated secret for admin maze preview entropy. When unset, preview entropy uses a namespaced fallback derived from the live maze secret so preview artifacts cannot forge production traversal tokens. |
| `SHUMA_FORWARDED_IP_SECRET` | Yes | `changeme-prod-forwarded-ip-secret` | Trust boundary secret for forwarded IP/proto headers (`X-Shuma-Forwarded-Secret`). |
| `SHUMA_HEALTH_SECRET` | No | empty | Optional shared secret for `/health` via `X-Shuma-Health-Secret`. |
| `SHUMA_ADMIN_IP_ALLOWLIST` | No (Yes for production deploys) | empty | CIDR/IP allowlist for `/admin/*`; required by deployment guardrails in production workflows. |
| `SHUMA_ADMIN_AUTH_FAILURE_LIMIT_PER_MINUTE` | No | `10` | Per-IP per-minute limit for failed admin authentication attempts before returning `429`. |
| `SHUMA_EVENT_LOG_RETENTION_HOURS` | Yes | `168` | Event retention window in hours (`0` disables cleanup). |
| `SHUMA_ADMIN_CONFIG_WRITE_ENABLED` | Yes | `false` | Enables/disables admin config writes to KV (`POST /admin/config`). |
| `SHUMA_KV_STORE_FAIL_OPEN` | Yes | `true` | KV failure policy (`true` fail-open, `false` fail-closed). |
| `SHUMA_ENFORCE_HTTPS` | Yes | `false` | Rejects non-HTTPS requests when `true` (proxy/header trust rules still apply). |
| `SHUMA_DEBUG_HEADERS` | Yes | `false` | Enables internal debug headers (for example health diagnostics). Keep `false` in production. |
| `SHUMA_ENTERPRISE_MULTI_INSTANCE` | No | `false` | Marks deployment as enterprise multi-instance for runtime/deploy state guardrails. |
| `SHUMA_ENTERPRISE_UNSYNCED_STATE_EXCEPTION_CONFIRMED` | No | `false` | Explicit temporary attestation for advisory/off operation when enterprise multi-instance still uses local-only rate/ban state. |
| `SHUMA_RATE_LIMITER_REDIS_URL` | No | empty | Redis endpoint for external distributed rate limiter mode (`redis://...` or `rediss://...`). |
| `SHUMA_BAN_STORE_REDIS_URL` | No | empty | Redis endpoint for external distributed ban store mode (`redis://...` or `rediss://...`). |
| `SHUMA_RATE_LIMITER_OUTAGE_MODE_MAIN` | No | `fallback_internal` | Outage posture for external rate-limiter degradation on main traffic (`fallback_internal`, `fail_open`, `fail_closed`). |
| `SHUMA_RATE_LIMITER_OUTAGE_MODE_ADMIN_AUTH` | No | `fail_closed` | Outage posture for external rate-limiter degradation on admin-auth routes (`fallback_internal`, `fail_open`, `fail_closed`). |

Use `make env-help` for the supported env-only override list.

### üêô KV Tunables (Seeded From `config/defaults.env`)

These keys are seeded into KV and loaded from KV at runtime.

| Variable | Default | Purpose |
| --- | --- | --- |
| `SHUMA_TEST_MODE` | `false` | Enables test-mode behavior for controlled local testing. |
| `SHUMA_JS_REQUIRED_ENFORCED` | `true` | Enforces JS verification (`js_verified` cookie gate). |
| `SHUMA_MODE_RATE` | `both` | Rate module mode: `off`, `signal`, `enforce`, `both`. |
| `SHUMA_MODE_GEO` | `both` | GEO module mode: `off`, `signal`, `enforce`, `both`. |
| `SHUMA_MODE_JS` | `both` | JS module mode: `off`, `signal`, `enforce`, `both` (still gated by `js_required_enforced`). |
| `SHUMA_PROVIDER_RATE_LIMITER` | `internal` | Backend selection for rate limiting capability (`internal`, `external`). |
| `SHUMA_PROVIDER_BAN_STORE` | `internal` | Backend selection for ban store/sync capability (`internal`, `external`). |
| `SHUMA_PROVIDER_CHALLENGE_ENGINE` | `internal` | Backend selection for challenge engine capability (`internal`, `external`). |
| `SHUMA_PROVIDER_MAZE_TARPIT` | `internal` | Backend selection for maze/tarpit capability (`internal`, `external`). |
| `SHUMA_PROVIDER_FINGERPRINT_SIGNAL` | `internal` | Backend selection for fingerprint signal capability (`internal`, `external`). |
| `SHUMA_EDGE_INTEGRATION_MODE` | `off` | Managed-edge integration precedence: `off` ignores Akamai-style edge outcomes, `advisory` ingests edge outcomes as non-authoritative signals, `authoritative` enables supported edge short-circuit actions (currently strong external fingerprint auto-ban). |
| `SHUMA_POW_ENABLED` | `true` | Enables PoW in JS verification flow. |
| `SHUMA_POW_DIFFICULTY` | `15` | PoW cost level (clamped to supported range). |
| `SHUMA_POW_TTL_SECONDS` | `90` | PoW seed lifetime in seconds (clamped). |
| `SHUMA_CHALLENGE_PUZZLE_ENABLED` | `true` | Enables challenge puzzle routing at the challenge escalation step. |
| `SHUMA_CHALLENGE_PUZZLE_TRANSFORM_COUNT` | `6` | Number of transform options shown in the puzzle challenge (4-8). |
| `SHUMA_CHALLENGE_PUZZLE_RISK_THRESHOLD` | `3` | Botness score threshold for serving challenge step-up. |
| `SHUMA_NOT_A_BOT_ENABLED` | `true` | Enables not-a-bot checkbox routing at medium botness certainty. |
| `SHUMA_NOT_A_BOT_RISK_THRESHOLD` | `2` | Botness score threshold for serving not-a-bot (must remain below challenge threshold when challenge threshold > 1). |
| `SHUMA_NOT_A_BOT_SCORE_PASS_MIN` | `7` | Minimum not-a-bot score for pass outcome. |
| `SHUMA_NOT_A_BOT_SCORE_ESCALATE_MIN` | `4` | Minimum not-a-bot score for puzzle escalation (must be <= pass threshold). |
| `SHUMA_NOT_A_BOT_NONCE_TTL_SECONDS` | `120` | Not-a-bot signed seed lifetime in seconds (30-300). |
| `SHUMA_NOT_A_BOT_MARKER_TTL_SECONDS` | `600` | Not-a-bot post-pass marker lifetime in seconds (60-3600). |
| `SHUMA_NOT_A_BOT_ATTEMPT_LIMIT_PER_WINDOW` | `6` | Not-a-bot per-bucket submit cap in each attempt window (1-100). |
| `SHUMA_NOT_A_BOT_ATTEMPT_WINDOW_SECONDS` | `300` | Not-a-bot attempt window duration in seconds (30-3600). |
| `SHUMA_BOTNESS_MAZE_THRESHOLD` | `6` | Botness score threshold for routing to maze. |
| `SHUMA_BOTNESS_WEIGHT_JS_REQUIRED` | `1` | Score weight for missing JS verification signal. |
| `SHUMA_BOTNESS_WEIGHT_GEO_RISK` | `2` | Score weight for GEO risk-country signal. |
| `SHUMA_BOTNESS_WEIGHT_RATE_MEDIUM` | `1` | Score weight for medium request-rate pressure. |
| `SHUMA_BOTNESS_WEIGHT_RATE_HIGH` | `2` | Score weight for high request-rate pressure. |
| `SHUMA_BOTNESS_WEIGHT_MAZE_BEHAVIOR` | `2` | Score weight for suspicious maze traversal behavior signal. |
| `SHUMA_BAN_DURATION` | `21600` | Legacy/default ban duration fallback (seconds). |
| `SHUMA_BAN_DURATION_HONEYPOT` | `86400` | Ban duration for honeypot/instaban trigger (seconds). |
| `SHUMA_BAN_DURATION_RATE_LIMIT` | `3600` | Ban duration for rate-limit ban (seconds). |
| `SHUMA_BAN_DURATION_BROWSER` | `21600` | Ban duration for browser-policy based bans (seconds). |
| `SHUMA_BAN_DURATION_ADMIN` | `21600` | Ban duration for manual admin bans (seconds). |
| `SHUMA_BAN_DURATION_CDP` | `43200` | Ban duration for CDP automation bans (seconds). |
| `SHUMA_RATE_LIMIT` | `80` | Requests per minute threshold for rate limiting. |
| `SHUMA_HONEYPOT_ENABLED` | `true` | Enables/disables honeypot trap handling for configured honeypot paths. |
| `SHUMA_HONEYPOTS` | `['/instaban']` | Honeypot endpoints that immediately trigger ban flow. |
| `SHUMA_BROWSER_BLOCK` | `[["Chrome",120],["Firefox",115],["Safari",15]]` | Browser/version minimums used by browser policy checks. |
| `SHUMA_BROWSER_WHITELIST` | `[]` | Optional browser/version allowlist exceptions. |
| `SHUMA_GEO_RISK_COUNTRIES` | `[]` | 2-letter countries that add GEO botness score. |
| `SHUMA_GEO_ALLOW_COUNTRIES` | `[]` | 2-letter countries explicitly allowed in GEO routing precedence. |
| `SHUMA_GEO_CHALLENGE_COUNTRIES` | `[]` | 2-letter countries forced to challenge tier. |
| `SHUMA_GEO_MAZE_COUNTRIES` | `[]` | 2-letter countries forced to maze tier. |
| `SHUMA_GEO_BLOCK_COUNTRIES` | `[]` | 2-letter countries forced to block tier. |
| `SHUMA_WHITELIST` | `[]` | IP/CIDR allowlist bypassing bot defenses. |
| `SHUMA_PATH_WHITELIST` | `[]` | URL path allowlist bypassing bot defenses. |
| `SHUMA_MAZE_ENABLED` | `true` | Enables maze feature. |
| `SHUMA_MAZE_AUTO_BAN` | `true` | Enables maze auto-ban when threshold is exceeded. |
| `SHUMA_MAZE_AUTO_BAN_THRESHOLD` | `50` | Maze hit threshold for auto-ban. |
| `SHUMA_MAZE_ROLLOUT_PHASE` | `enforce` | Maze rollout phase (`instrument`, `advisory`, `enforce`). |
| `SHUMA_MAZE_TOKEN_TTL_SECONDS` | `90` | Maze traversal token TTL. |
| `SHUMA_MAZE_TOKEN_MAX_DEPTH` | `8` | Maximum signed traversal depth. |
| `SHUMA_MAZE_TOKEN_BRANCH_BUDGET` | `3` | Signed branch budget field for issued traversal tokens. |
| `SHUMA_MAZE_REPLAY_TTL_SECONDS` | `600` | Replay-marker retention window for traversal tokens. |
| `SHUMA_MAZE_ENTROPY_WINDOW_SECONDS` | `60` | Entropy rotation window for maze variant selection. |
| `SHUMA_MAZE_CLIENT_EXPANSION_ENABLED` | `true` | Enables checkpointed client-side expansion behavior for suspicious tiers. |
| `SHUMA_MAZE_CHECKPOINT_EVERY_NODES` | `3` | Checkpoint cadence in nodes. |
| `SHUMA_MAZE_CHECKPOINT_EVERY_MS` | `1500` | Checkpoint cadence in elapsed milliseconds. |
| `SHUMA_MAZE_STEP_AHEAD_MAX` | `4` | Maximum unverified step-ahead depth before checkpoint fallback. |
| `SHUMA_MAZE_NO_JS_FALLBACK_MAX_DEPTH` | `4` | Maximum depth tolerated without checkpoint evidence. |
| `SHUMA_MAZE_MICRO_POW_ENABLED` | `true` | Enables optional deep-tier micro-PoW for traversal links. |
| `SHUMA_MAZE_MICRO_POW_DEPTH_START` | `5` | Depth where micro-PoW starts. |
| `SHUMA_MAZE_MICRO_POW_BASE_DIFFICULTY` | `12` | Base micro-PoW difficulty in leading-zero bits. |
| `SHUMA_MAZE_MAX_CONCURRENT_GLOBAL` | `128` | Global concurrent maze-response budget. |
| `SHUMA_MAZE_MAX_CONCURRENT_PER_IP_BUCKET` | `4` | Per-IP-bucket concurrent maze-response budget. |
| `SHUMA_MAZE_MAX_RESPONSE_BYTES` | `65536` | Max response size per maze page before budget fallback. |
| `SHUMA_MAZE_MAX_RESPONSE_DURATION_MS` | `15000` | Max render duration per maze page before budget fallback. |
| `SHUMA_MAZE_SERVER_VISIBLE_LINKS` | `4` | Number of server-visible maze links before hidden client expansion links. |
| `SHUMA_MAZE_MAX_LINKS` | `16` | Hard cap on generated links per maze page. |
| `SHUMA_MAZE_MAX_PARAGRAPHS` | `8` | Hard cap on generated paragraphs per maze page. |
| `SHUMA_MAZE_PATH_ENTROPY_SEGMENT_LEN` | `16` | Entropy segment length for generated maze paths. |
| `SHUMA_MAZE_COVERT_DECOYS_ENABLED` | `true` | Enables covert decoy injection in eligible non-maze HTML for medium-suspicion traffic. |
| `SHUMA_MAZE_SEED_PROVIDER` | `internal` | Maze seed corpus provider (`internal` or `operator`). |
| `SHUMA_MAZE_SEED_REFRESH_INTERVAL_SECONDS` | `3600` | Scheduled refresh interval for provider-fed seed corpora. |
| `SHUMA_MAZE_SEED_REFRESH_RATE_LIMIT_PER_HOUR` | `12` | Hourly refresh cap for provider-fed corpus refreshes. |
| `SHUMA_MAZE_SEED_REFRESH_MAX_SOURCES` | `100` | Maximum operator sources accepted for seed provider refresh. |
| `SHUMA_MAZE_SEED_METADATA_ONLY` | `true` | Enforce metadata/keyword-first extraction for operator seeds. |
| `SHUMA_ROBOTS_ENABLED` | `true` | Enables robots.txt endpoint and policy generation. |
| `SHUMA_ROBOTS_BLOCK_AI_TRAINING` | `true` | Adds AI training bot disallow directives. |
| `SHUMA_ROBOTS_BLOCK_AI_SEARCH` | `false` | Adds AI search bot disallow directives. |
| `SHUMA_ROBOTS_ALLOW_SEARCH_ENGINES` | `true` | Allows mainstream search engines in robots policy. |
| `SHUMA_AI_POLICY_BLOCK_TRAINING` | `true` | First-class admin/export alias for AI training policy (mirrors `SHUMA_ROBOTS_BLOCK_AI_TRAINING`). |
| `SHUMA_AI_POLICY_BLOCK_SEARCH` | `false` | First-class admin/export alias for AI search policy (mirrors `SHUMA_ROBOTS_BLOCK_AI_SEARCH`). |
| `SHUMA_AI_POLICY_ALLOW_SEARCH_ENGINES` | `true` | First-class admin/export alias for search-engine allow policy (mirrors `SHUMA_ROBOTS_ALLOW_SEARCH_ENGINES`). |
| `SHUMA_ROBOTS_CRAWL_DELAY` | `2` | robots.txt crawl-delay value (seconds). |
| `SHUMA_CDP_DETECTION_ENABLED` | `true` | Enables CDP automation detection script/processing. |
| `SHUMA_CDP_AUTO_BAN` | `true` | Enables auto-ban path when strong CDP automation is detected. |
| `SHUMA_CDP_DETECTION_THRESHOLD` | `0.8` | CDP score threshold used when hard CDP checks are absent. |
| `SHUMA_CDP_PROBE_FAMILY` | `split` | CDP detector probe family selector (`v1`, `v2`, `split`) for rollout/rotation. |
| `SHUMA_CDP_PROBE_ROLLOUT_PERCENT` | `30` | Percent of requests that should receive `v2` probes when `cdp_probe_family=split` (0-100). |
| `SHUMA_FINGERPRINT_SIGNAL_ENABLED` | `true` | Enables internal fingerprint signal collection and scoring contributions. |
| `SHUMA_FINGERPRINT_STATE_TTL_SECONDS` | `900` | TTL for bounded fingerprint state/coherence windows. |
| `SHUMA_FINGERPRINT_FLOW_WINDOW_SECONDS` | `120` | Rolling flow window used for mismatch aggregation and flow-centric telemetry checks. |
| `SHUMA_FINGERPRINT_FLOW_VIOLATION_THRESHOLD` | `3` | Per-flow mismatch threshold before emitting flow-violation fingerprint signals. |
| `SHUMA_FINGERPRINT_PSEUDONYMIZE` | `true` | Uses pseudonymized flow identity for fingerprint state keys (data-minimization control). |
| `SHUMA_FINGERPRINT_ENTROPY_BUDGET` | `4` | Max cumulative fingerprint contribution budget applied by botness signal accumulator. |
| `SHUMA_FINGERPRINT_FAMILY_CAP_HEADER_RUNTIME` | `2` | Per-family cap for header/runtime fingerprint contributions. |
| `SHUMA_FINGERPRINT_FAMILY_CAP_TRANSPORT` | `3` | Per-family cap for transport/edge fingerprint contributions. |
| `SHUMA_FINGERPRINT_FAMILY_CAP_TEMPORAL` | `2` | Per-family cap for temporal coherence fingerprint contributions. |
| `SHUMA_FINGERPRINT_FAMILY_CAP_PERSISTENCE` | `1` | Per-family cap for persistence-abuse fingerprint contributions. |
| `SHUMA_FINGERPRINT_FAMILY_CAP_BEHAVIOR` | `2` | Per-family cap for low-friction behavioral fingerprint contributions. |

## üêô Admin Config Writes

- `GET /admin/config` reads effective KV-backed config.
- `POST /admin/config` writes to KV only when `SHUMA_ADMIN_CONFIG_WRITE_ENABLED=true`.
- `GET /admin/config/export` returns a non-secret deploy handoff snapshot as env-style key/value output:
  - `env`: object of deploy-ready `SHUMA_*` non-secret values (env guardrails + KV tunables),
  - `env_text`: newline-delimited `KEY=value` output for copy/paste into immutable deploy config,
  - `excluded_secrets`: explicit list of secret keys intentionally omitted (includes `SHUMA_RATE_LIMITER_REDIS_URL` and `SHUMA_BAN_STORE_REDIS_URL`).
- Successful writes invalidate runtime config cache on the instance that processed the request.
- KV writes persist across restarts.

### `POST /admin/config` writable keys

The following KV-backed fields are currently writable via admin API:

- Core: `test_mode`, `rate_limit`, `ban_duration`, `ban_durations.{honeypot,rate_limit,browser,admin,cdp}`, `honeypot_enabled`, `honeypots`, `browser_block`, `browser_whitelist`, `whitelist`, `path_whitelist`, `js_required_enforced`.
- GEO routing/policy: `geo_risk`, `geo_allow`, `geo_challenge`, `geo_maze`, `geo_block`.
- Maze: `maze_enabled`, `maze_auto_ban`, `maze_auto_ban_threshold`, `maze_rollout_phase`, `maze_token_ttl_seconds`, `maze_token_max_depth`, `maze_token_branch_budget`, `maze_replay_ttl_seconds`, `maze_entropy_window_seconds`, `maze_client_expansion_enabled`, `maze_checkpoint_every_nodes`, `maze_checkpoint_every_ms`, `maze_step_ahead_max`, `maze_no_js_fallback_max_depth`, `maze_micro_pow_enabled`, `maze_micro_pow_depth_start`, `maze_micro_pow_base_difficulty`, `maze_max_concurrent_global`, `maze_max_concurrent_per_ip_bucket`, `maze_max_response_bytes`, `maze_max_response_duration_ms`, `maze_server_visible_links`, `maze_max_links`, `maze_max_paragraphs`, `maze_path_entropy_segment_len`, `maze_covert_decoys_enabled`, `maze_seed_provider`, `maze_seed_refresh_interval_seconds`, `maze_seed_refresh_rate_limit_per_hour`, `maze_seed_refresh_max_sources`, `maze_seed_metadata_only`.
- Robots/AI policy: `robots_enabled`, `robots_crawl_delay`, `ai_policy_block_training`, `ai_policy_block_search`, `ai_policy_allow_search_engines` (legacy aliases `robots_block_ai_training`, `robots_block_ai_search`, `robots_allow_search_engines` are also accepted).
- CDP/fingerprint: `cdp_detection_enabled`, `cdp_auto_ban`, `cdp_detection_threshold`, `cdp_probe_family`, `cdp_probe_rollout_percent`, `fingerprint_signal_enabled`, `fingerprint_state_ttl_seconds`, `fingerprint_flow_window_seconds`, `fingerprint_flow_violation_threshold`, `fingerprint_pseudonymize`, `fingerprint_entropy_budget`, `fingerprint_family_cap_header_runtime`, `fingerprint_family_cap_transport`, `fingerprint_family_cap_temporal`, `fingerprint_family_cap_persistence`, `fingerprint_family_cap_behavior`.
- Provider/edge: `provider_backends.{rate_limiter,ban_store,challenge_engine,maze_tarpit,fingerprint_signal}`, `edge_integration_mode`.
- Botness/challenge tuning: `pow_enabled`, `pow_difficulty`, `pow_ttl_seconds`, `challenge_puzzle_enabled`, `challenge_puzzle_transform_count`, `challenge_puzzle_risk_threshold`, `not_a_bot_enabled`, `not_a_bot_risk_threshold`, `not_a_bot_score_pass_min`, `not_a_bot_score_escalate_min`, `not_a_bot_nonce_ttl_seconds`, `not_a_bot_marker_ttl_seconds`, `not_a_bot_attempt_limit_per_window`, `not_a_bot_attempt_window_seconds`, `botness_maze_threshold`, `botness_weights.{js_required,geo_risk,rate_medium,rate_high,maze_behavior}`, `defence_modes.{rate,geo,js}`.

Shuma follows a 2-class model only:
- Env-only runtime keys in the Env-Only table above.
- KV-backed tunables writable via `POST /admin/config`.

## üêô JS Verification + PoW

- `js_required_enforced=true` routes visitors without a valid `js_verified` cookie to JS verification.
- `pow_enabled=true` adds server-verified PoW to that verification flow.
- `js_required_enforced=false` bypasses JS verification for normal requests (and therefore bypasses PoW on that path).
- `challenge_puzzle_enabled=false` disables challenge-page serving; challenge-tier routes fall back to maze when `maze_enabled=true`, otherwise hard block.

### CDP/Fingerprint rollout controls

- `cdp_probe_family` controls detector script family selection:
  - `v1`: legacy probe set only,
  - `v2`: expanded probe set (includes persistence/micro-signal checks),
  - `split`: deterministic request-based split rollout between `v1` and `v2`.
- `cdp_probe_rollout_percent` is used only when `cdp_probe_family=split`.
- `fingerprint_signal_enabled=false` disables fingerprint signal contributions while keeping CDP endpoint handling available.
- Fingerprint state/privacy controls are bounded by:
  - `fingerprint_state_ttl_seconds`,
  - `fingerprint_flow_window_seconds`,
  - `fingerprint_pseudonymize`,
  - `fingerprint_entropy_budget` and the per-family cap keys.

## üêô Maze Rollout Phases

`SHUMA_MAZE_ROLLOUT_PHASE` controls how strictly maze violations are enforced:

- `instrument`: record maze token/proof/checkpoint/budget outcomes without hard fallback enforcement.
- `advisory`: enforce budget saturation fallbacks; keep token/proof/checkpoint violations advisory.
- `enforce`: enforce token, replay, binding, checkpoint, proof, and budget fallbacks.

Recommended promotion order is `instrument -> advisory -> enforce` with explicit rollback criteria.

## üêô Maze Stage 2.5 Runtime Notes

- Maze pages now use a compact HTML shell with versioned shared assets under an opaque deployment-specific maze asset prefix (immutable cache policy).
- Hidden-link expansion is progressive via `POST <maze_path_prefix>issue-links` using signed expansion-seed envelopes (`seed` + `seed_sig`) instead of shipping full hidden-link sets in bootstrap payloads.
- Parent-token issuance at the maze issue-links endpoint is single-use (replay calls are rejected) to reduce repeat host work.
- Branch-budget controls now bound progressive hidden-link issuance volume per traversal token.
- Deep-tier proof/expansion compute executes in a Web Worker, with constrained-device safeguards that reduce requested expansion/proof work before hard fallback.
- High-confidence violation accumulation now degrades from challenge fallback to block fallback before continuing expensive maze serving.

## üêô Static Resource Bypass Defaults

To avoid expensive bot checks on obvious static resources, Shuma bypasses JS/botness/geo challenge paths by default for:

- `GET`/`HEAD` requests only, and
- obvious asset paths/extensions (for example `/assets/...`, `/static/...`, `/img/...`, `*.css`, `*.js`, `*.png`, `*.svg`, `*.woff2`, `favicon`, `manifest`, `sitemap`).

Guardrails:

- admin and challenge control paths are excluded from this bypass,
- non-`GET`/`HEAD` requests do not use this bypass.

## üêô Composability Modes (`off`/`signal`/`enforce`/`both`)

Mode semantics for eligible modules (`rate`, `geo`, `js`):

- `off`: no scored signal contribution and no enforcement action.
- `signal`: contribute scored signal only; no direct enforcement action.
- `enforce`: allow direct enforcement path only; no scored contribution.
- `both`: enable both scored contribution and enforcement path.

Default seeded modes are `both` for all three modules as the current pre-launch baseline (`rate=both`, `geo=both`, `js=both`).

### Effective mode notes and invalid combinations

- `js_required_enforced` is still a hard gate for JS paths.
- When `js_required_enforced=false`, JS signal and JS enforcement are both effectively disabled even if `defence_modes.js` is `signal`, `enforce`, or `both`.
- `/admin/config` surfaces this as:
  - `defence_modes` (configured modes),
  - `defence_modes_effective` (runtime-effective signal/action booleans),
  - `defence_mode_warnings` (configuration conflict notes).

### Tuning implications

- `rate=signal` keeps botness pressure scoring without rate-limit bans; useful for dry-run tuning.
- `rate=enforce` keeps hard caps/bans but removes rate pressure from botness scoring.
- `geo=signal` keeps GEO risk scoring while deferring GEO routing actions (`block/challenge/maze`) to other controls.
- `geo=enforce` keeps explicit GEO routing actions but removes GEO contribution to botness score.
- `js=signal` or `js=enforce` still require `js_required_enforced=true`; otherwise JS signal/action are both effectively disabled.

## üêô Provider Selection (H4 foundation)

- Provider selection is now explicit in config under `provider_backends`.
- All capabilities default to `internal`.
- `external` backend behavior in the current slice:
  - `fingerprint_signal=external` routes to an Akamai-first adapter (`/fingerprint-report`) that accepts edge/Bot Manager-style outcome payloads, maps them into normalized fingerprint/CDP-tier signals, and preserves explicit fallback to the internal CDP report handler for non-Akamai/legacy payloads.
  - Fingerprint source availability is explicit:
    - internal provider reports `active` when `cdp_detection_enabled=true`, `disabled` when `cdp_detection_enabled=false`.
    - external Akamai adapter reports `active` when `cdp_detection_enabled=true`, `disabled` when `cdp_detection_enabled=false`.
  - `rate_limiter=external` uses a Redis-backed distributed adapter (`INCR` + window TTL) when `SHUMA_RATE_LIMITER_REDIS_URL` is configured.
    - On backend degradation it applies route-class outage posture:
      - main traffic: `SHUMA_RATE_LIMITER_OUTAGE_MODE_MAIN` (default `fallback_internal`)
      - admin auth: `SHUMA_RATE_LIMITER_OUTAGE_MODE_ADMIN_AUTH` (default `fail_closed`)
  - `ban_store=external` uses a Redis-backed distributed adapter (keyed JSON ban entries with Redis TTL) when `SHUMA_BAN_STORE_REDIS_URL` is configured, with explicit fallback to internal behavior when unavailable/unconfigured.
  - `challenge_engine=external` and `maze_tarpit=external` still route through explicit unsupported external adapters that currently fall back to internal runtime behavior.
- `edge_integration_mode` defaults to `off` for self-hosted baseline.
- External fingerprint adapter precedence is mode-aware:
  - `off`: ignore Akamai-style edge outcomes (legacy/non-Akamai payloads still fall back to internal CDP handler).
  - `advisory`: record normalized edge detections without authoritative ban short-circuit.
  - `authoritative`: allow strong edge outcomes to trigger immediate auto-ban when `cdp_auto_ban=true`.

### Provider + Edge Matrix (Operator Quick Reference)

This matrix is meant to answer: "What actually happens if I change this setting?"

| Capability | `internal` backend | `external` backend (current) | Advisory mode intent | Authoritative mode intent | Safe fallback behavior |
| --- | --- | --- | --- | --- | --- |
| `fingerprint_signal` | Uses internal CDP scripts and `/cdp-report` | Uses Akamai-first adapter (`/fingerprint-report`) that maps edge outcomes and falls back to internal CDP handler for non-Akamai/legacy payloads | Edge outcomes are ingested/logged without authoritative edge-ban short-circuit | Strong edge outcomes can trigger immediate auto-ban when `cdp_auto_ban=true` | Non-Akamai/legacy payloads downgrade to internal CDP handling; `off` mode ignores Akamai-style edge outcomes |
| `rate_limiter` | Internal local rate logic | Redis-backed distributed limiter (`INCR` + TTL) with configurable outage posture (`fallback_internal`/`fail_open`/`fail_closed`) by route class | Consume distributed rate state as advisory pressure | External authoritative limit decisions only after semantic parity and outage posture are validated | Applies route-class outage mode on Redis unavailability/degradation |
| `ban_store` | Internal ban persistence and checks | Redis-backed distributed ban adapter with fallback to internal when external backend is unavailable/unconfigured | Use distributed ban state as advisory input | External authoritative ban sync only with explicit outage controls | Falls back to internal ban store on Redis unavailability/misconfiguration |
| `challenge_engine` | Internal challenge rendering/verification | Explicit unsupported external adapter currently delegates to internal behavior | External challenge attestations may inform policy once implemented | Authoritative external challenge only when replay/expiry semantics are parity-tested | Unsupported external path keeps internal challenge path |
| `maze_tarpit` | Internal Shuma-native maze/tarpit | Explicit unsupported external adapter delegates to internal behavior | Keep internal (no practical external target currently) | Keep internal | Internal-only path remains the source of truth |
| Policy composition (`botness`, routing, modes) | Internal | Not externalized | Shuma remains policy brain | Shuma remains policy brain | Not swappable by design |

### Recommended Config Profiles

Use these as startup presets, then tune incrementally:

1. `self_hosted_minimal`:
   - all `SHUMA_PROVIDER_*` values = `internal`
   - `SHUMA_EDGE_INTEGRATION_MODE=off`
2. `enterprise_akamai` (advisory-first):
   - begin with all providers `internal`
   - enable one external provider at a time only after staging soak
   - set `SHUMA_EDGE_INTEGRATION_MODE=advisory` during initial enterprise rollout
3. `enterprise_akamai` (authoritative-optional):
   - only after advisory stability and rollback rehearsal
   - keep non-validated capabilities on `internal`
   - set `SHUMA_EDGE_INTEGRATION_MODE=authoritative` only for validated integrations

### Profile-Gated Distributed State Rule

- Keep policy logic shared across all profiles; do not maintain a separate policy branch for enterprise.
- `self_hosted_minimal` is valid with internal local state only.
- `enterprise_akamai` should move `rate_limiter` and `ban_store` to distributed/external adapters before multi-instance authoritative rollout.
- Multi-instance deployments using only local state should be treated as advisory/staging posture until distributed state correctness is enabled.
- Deploy-time guardrail keys for this posture are documented in `docs/deployment.md`:
  - `SHUMA_ENTERPRISE_MULTI_INSTANCE`
  - `SHUMA_ENTERPRISE_UNSYNCED_STATE_EXCEPTION_CONFIRMED`
  - `SHUMA_RATE_LIMITER_REDIS_URL` (required when `SHUMA_PROVIDER_RATE_LIMITER=external` under enterprise multi-instance posture)
  - `SHUMA_BAN_STORE_REDIS_URL` (required when `SHUMA_PROVIDER_BAN_STORE=external` under enterprise multi-instance posture)
  - `SHUMA_RATE_LIMITER_OUTAGE_MODE_MAIN` / `SHUMA_RATE_LIMITER_OUTAGE_MODE_ADMIN_AUTH` (recommended explicit posture selection for degraded external limiter behavior)

### Observability surfaces for composability

- `/metrics` includes:
  - `bot_defence_botness_signal_state_total{signal="...",state="active|disabled|unavailable"}`
  - `bot_defence_defence_mode_effective_total{module="rate|geo|js",configured="off|signal|enforce|both",signal_enabled="true|false",action_enabled="true|false"}`
  - `bot_defence_edge_integration_mode_total{mode="off|advisory|authoritative"}`
  - `bot_defence_provider_implementation_effective_total{capability="...",backend="internal|external",implementation="..."}`
  - `bot_defence_rate_limiter_backend_errors_total{route_class="main_traffic|admin_auth"}`
  - `bot_defence_rate_limiter_outage_decisions_total{route_class="...",mode="fallback_internal|fail_open|fail_closed",action="fallback_internal|allow|deny",decision="allowed|limited"}`
  - `bot_defence_rate_limiter_usage_fallback_total{route_class="...",reason="backend_error|backend_missing"}`
  - `bot_defence_rate_limiter_state_drift_observations_total{route_class="...",delta_band="delta_0|delta_1_5|delta_6_20|delta_21_plus"}`
  - `bot_defence_policy_matches_total{level="L*...",action="A*...",detection="D*..."}`
  - `bot_defence_policy_signals_total{signal="S_*"}`
- Botness-driven maze/challenge event outcomes include both:
  - `signal_states` summary (`key:state:contribution`),
  - effective runtime metadata summary (`modes=... edge=...`),
  - provider summary (`providers=capability=backend/implementation ...`).
  - canonical taxonomy suffix (`taxonomy[level=L* action=A* detection=D* signals=S_*...]`).

### Public Escalation Ladder Reference

- The canonical public escalation ladder (`L0_ALLOW_CLEAN` through `L11_DENY_HARD`) is documented in `/docs/bot-defence.md` under `Escalation Ladder (L0-L11)`.
- Use that ladder as the operator-facing policy vocabulary; metrics and admin events reuse the same IDs.
- Signal semantics (for example `S_JS_REQUIRED_MISSING` meaning missing/expired/invalid `js_verified` marker under JS enforcement) are documented alongside that ladder and should be treated as evidence inputs, not separate action levels.

## üêô GEO Trust Boundary

GEO/proto headers are trusted only when:

- `SHUMA_FORWARDED_IP_SECRET` is configured, and
- request includes matching `X-Shuma-Forwarded-Secret`.

Without trust, forwarded IP/proto/GEO-derived routing and GEO scoring are skipped.
