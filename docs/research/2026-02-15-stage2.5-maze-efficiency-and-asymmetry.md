# Stage 2.5 Maze Efficiency and Asymmetry Research Synthesis (MZ-X0..MZ-X10)

Date: 2026-02-15
Status: Implemented (research + implementation baseline complete)

## Purpose

This document defines the research-phase decisions for Stage 2.5 follow-up tasks (`MZ-X0` through `MZ-X10`).
It translates prior references and current implementation findings into concrete implementation choices with acceptance criteria.

## Inputs

- Existing Stage 2 synthesis: `docs/research/2026-02-14-maze-tarpit-research-synthesis.md`
- Maze excellence plan: `docs/plans/2026-02-13-maze-excellence-plan.md`
- Current runtime and renderer behavior (`src/maze/runtime.rs`, `src/maze/renders.rs`, `src/maze/token.rs`)

## Research Findings to Design Decisions

### MZ-X0: Client-side branch generation

Finding:
- Static server-generated branch sets create avoidable host bandwidth/CPU cost.
- Hybrid model is preferable to JS-only hard dependency because suspicious no-JS traffic still needs bounded progression.

Decision:
- Use compact signed bootstrap + Web Worker generation for hidden candidate branches.
- Keep server-visible links as bounded no-JS-compatible fallback.

Acceptance criteria:
1. Hidden candidate branch generation runs in a Worker, not main thread.
2. Entry payload no longer ships full hidden tokenized links.
3. No-JS path still has bounded visible progression.

### MZ-X1 + MZ-X5: Traversal token semantics and chain integrity

Finding:
- Prefix-only binding is too weak for high-confidence anti-replay guarantees.
- Sibling edge reuse risk is increased when operation IDs are not edge-unique.

Decision:
- Add exact path commitment to traversal token.
- Make operation IDs edge-unique (path-bound).
- Enforce branch budget and previous-node continuity checks in runtime.

Acceptance criteria:
1. Token verify rejects path mismatch for the current request path.
2. Runtime rejects zero/invalid branch budget.
3. Runtime rejects broken chain continuity markers.
4. Sibling tokens produce distinct operation IDs.

### MZ-X2 + MZ-X9: Styling realism with low overhead

Finding:
- Realism reduces honeypot fingerprintability.
- Full inline CSS/JS per hop is unnecessary bandwidth overhead.

Decision:
- Move to external shared, minified assets with content-hash versioning.
- Introduce adaptive styling tiers keyed by botness/depth/violation history:
  - `full` (minimal realistic theme),
  - `lite` (ultra-minimal),
  - `machine` (plausible no-CSS-like surface without giveaway copy).

Acceptance criteria:
1. Maze pages link external CSS/JS assets (not full inline style/script blocks).
2. Asset URLs are versioned via stable hashes.
3. Shared assets are cacheable with immutable semantics.
4. High-confidence deep traversal can select machine-oriented low-style variant.

### MZ-X3: Progressive hidden-link issuance

Finding:
- Shipping full hidden links in bootstrap shifts too much bandwidth to host.

Decision:
- Hidden links are generated as client candidates and tokenized on-demand via proof/checkpoint-gated issuance endpoint.

Acceptance criteria:
1. Bootstrap no longer embeds full hidden tokenized link set.
2. Server issues hidden links in bounded batches after validation.
3. Link issuance is IP/UA/token context-bound.

### MZ-X4 + MZ-X6: Host cost minimization and proactive gating

Finding:
- Post-render caps are too late to avoid render cost.
- Per-hop writes should be bounded and prioritize violation writes over routine churn.

Decision:
- Add pre-admission estimate checks before render.
- Reduce routine per-hop scoring writes and retain strict writes for replay/checkpoint/violations.

Acceptance criteria:
1. Runtime can reject/degrade before render when estimated response cost exceeds cap.
2. Routine traversal writes are reduced without disabling safety-critical markers.

### MZ-X7: Measurable asymmetry

Finding:
- Without objective thresholds, regressions are easy to miss.

Decision:
- Add repeatable benchmark-like tests/harness for payload size, render latency envelope, and issuance volume.

Acceptance criteria:
1. CI-eligible tests assert payload/behavior budgets.
2. Documentation defines defender-cost targets and tracking method.

### MZ-X8: Client compute fairness

Finding:
- Main-thread heavy proof/generation can create avoidable UX degradation.

Decision:
- Move hidden branch generation and deep proof preparation to Worker path.
- Keep bounded fallback when Worker path fails.

Acceptance criteria:
1. Hidden branch generation occurs in Worker path.
2. Worker failure degrades safely (no panic/no hard crash path).

### MZ-X10: Pre-ban high-confidence escalation

Finding:
- High-confidence stacked violations should stop expensive maze serving earlier.

Decision:
- Add violation-accumulation matrix and early block/challenge fallback before auto-ban threshold.

Acceptance criteria:
1. Repeated high-confidence violation combinations can short-circuit maze serve.
2. Behavior is deterministic and observable via metrics/events.

## Rollout and Safety

1. Ship with conservative defaults.
2. Keep no-JS bounded progression.
3. Track regressions via Stage 2.5 metrics/tests before tightening thresholds.

## Implementation Status Snapshot (2026-02-15)

- Versioned shared maze assets + compact shell are active.
- Hidden-link bootstrap shipping is removed; progressive issuance is active via signed-seed `/maze/issue-links`.
- Path-bound token integrity and chain/replay checks are active.
- Worker-based expansion/proof path is active with constrained-device safeguards.
- Benchmark gate is active in `make test` through `make test-maze-benchmark`.
- Current benchmark snapshot:
  - `pages=6`
  - `avg_page_bytes=6436`
  - `legacy_bytes=7033`
  - `host_set_ops=41`
  - `attacker_requests=16`
  - `issue_links_calls=5`
  - `attacker_pow_iterations=5223`

## References

- `docs/research/2026-02-14-maze-tarpit-research-synthesis.md`
- `docs/plans/2026-02-13-maze-excellence-plan.md`
- PathMarker: https://cybersecurity.springeropen.com/articles/10.1186/s42400-019-0023-1
- Cloudflare AI Labyrinth: https://developers.cloudflare.com/bots/additional-configurations/ai-labyrinth/
